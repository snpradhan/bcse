{% extends "bcse_app/AdminConfiguration.html" %}
{% load bcse_extras %}
{% load base_extras %}

{% block configuration %}
  {% if form.instance.id %}
    <h1 class="center"> {{form.instance.name}} </h1>
  {% else %}
    <h1 class="center"> Create Consumable </h1>
  {% endif %}
  <div class="admin_form">
    <form method="post" enctype="multipart/form-data" id="formConsumable">
      {% csrf_token %}
      {{form.media}}
      {{form.id}}
      <div class="form-group mb-3">
        <label for="id_{{form.name.name}}" class="form-label"> {{form.name.label|title}}</label>
        <div>{{form.name}}</div>
        <div class="error">{{ form.name.errors }}</div>
      </div>      
      <div class="form-group mb-3">
        <label for="id_{{form.inventory.name}}" class="form-label"> {{form.inventory.label|title}}</label>
        <div>{{form.inventory}}</div>
        <div class="error">{{ form.inventory.errors }}</div>
      </div>

      <div class="form-group mb-3">
        <label class="form-label">Inventory <button type="button" class="btn" onclick="cloneForm('consumableinventory_set', 'inventory_formset')">Add </button> </label>
        <table class="table table-condensed table-bordered">
          <thead>
            <tr>
              <th>Storage Location</th>
              <th>Count</th>
              <th>Expiration Date</th>
              <th>Notes</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="inventory_formset">
            {{formset.management_form}}
            {% for form in formset %}
              {{form.id}}
              <tr class="form-row">
                <td>
                  {{form.storage_location}}
                  <div class="error">{{ form.storage_location.errors }}</div>
                </td>
                <td>
                  {{form.count}}
                  <div class="error">{{ form.count.errors }}</div>
                </td>
                <td>
                   <div class="input-group">
                      {{form.expiration_date}}
                      <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                    </div>
                  <div class="error">{{ form.expiration_date.errors }}</div>
                </td>
                <td>
                  {{form.notes}}
                  <div class="error">{{ form.notes.errors }}</div>
                </td>
                <td>
                  {{form.DELETE.as_hidden}}
                  <button type="button" class="btn btn-danger delete_inventory"><i class="fa-solid fa-trash-can"></i></button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="form-group mb-3">
        <label for="id_{{form.notes.name}}" class="form-label"> {{form.notes.label|title}}</label>
        <div>{{form.notes}}</div>
        <div class="error">{{ form.notes.errors }}</div>
      </div>
      <div class="form-group mb-3">
        <label for="id_{{form.unit_cost.name}}" class="form-label"> {{form.unit_cost.label|title}}($)</label>
        <div>{{form.unit_cost}}</div>
        <div class="error">{{ form.unit_cost.errors }}</div>
      </div>
      <div class="form-group mb-3">
        <label for="id_{{form.color.name}}" class="form-label"> {{form.color.label|title}}</label>
        <div>{{form.color}}</div>
        <div class="error">{{ form.color.errors }}</div>
      </div>
      
      <div class="form-group mb-3">
        <label for="id_{{form.image.name}}" class="form-label"> {{form.image.label|title}}</label>
        {% if form.instance.id and form.instance.image.url %}
          <div class="image_preview">
            <img src="{{form.instance.image.url}}" class="icon" alt="">
          </div>
        {% endif %}
        <div>{{form.image}}</div>
        <div class="error">{{ form.image.errors }}</div>
      </div>

      <div class="form-group mb-3">
        <label for="id_{{form.status.name}}" class="form-label"> {{form.status.label|title}}</label>
        <div>{{form.status}}</div>
        <div class="error">{{ form.status.errors }}</div>
      </div>
      <div class="form-group mb-3 right">
        {% if form.instance.id %}
          <button type="button" class="btn btn-danger delete action" data-href="{% url 'bcse:consumableDelete' form.instance.id %}" data-title="the consumable <strong>{{form.instance.name}}</strong>">
            Delete
          </button>
        {% endif %}
        <button class="btn" type="submit" id="submit_bottom">
          Save
        </button>
      </div>

    </form>
  </div>
  <script type="text/javascript">
    $(function(){
      $('.delete_inventory').on('click', function(e){
        formRow = $(this).closest('.form-row');
        deleteInput = formRow.find('input[type="hidden"][name$="-DELETE"]')[0];

        if (deleteInput) {
          $(deleteInput).val('on'); // Mark for deletion
          $(formRow).hide();
        }
      });
    });
  </script>
{% endblock %}

{% load bcse_extras %}

{% if tag == 'profile' %}
  <h2 class="center">My Baxter Box Reservations</h2>
{% endif %}
{% if reservations %}
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        {% if user.is_authenticated and user.userProfile.user_role in 'AS' and tag == 'reservations' %}
          <th> ID</th>
        {% endif %}
        <th> Reservation Made On</th>
        {% if user.is_authenticated and user.userProfile.user_role in 'AS' and tag == 'reservations' %}
          <th> User </th>
        {% endif %}
        <th> Kit </th>
        <th> Equipment </th>
        <th> Comments<br>(New/Total)</th>
        <th> Delivery Date </th>
        <th> Return Date </th>
        <th> Delivery Address </th>
        {% if user.is_authenticated and user.userProfile.user_role in 'AS' and tag == 'reservations' %}
          <th> Delivery Distance (miles) </th>
          <th> Delivery Travel Time (mins) </th>
          <th> Assigned To </th>
        {% endif %}
        <th> Status </th>
        <th> Actions </th>
      </tr>
    </thead>
    <tbody>
      {% for reservation in reservations %}
        <tr>
          {% if user.is_authenticated and user.userProfile.user_role in 'AS' and tag == 'reservations' %}
            <td> {{reservation.id}}</td>
          {% endif %}
          <td>{{reservation.created_date|date:"F j, Y"}}</td>
          {% if user.is_authenticated and user.userProfile.user_role in 'AS' and tag == 'reservations' %}
            <td> {{reservation.user}} </td>
          {% endif %}
          <td>
            {% if reservation.activity and not reservation.activity_kit_not_needed %}
              {{reservation.activity.kit_name}} x {{reservation.num_of_classes}}
            {% endif %}
          </td>
          <td>
            <ul>
              {% for equipment in reservation.equipment.all %}
                <li>
                  {{equipment.equipment_type}}
                  {% if user.is_authenticated and user.userProfile.user_role in 'AS' and tag == 'reservations' %}
                    ({{equipment.name}})
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </td>
          <td>
            {% with all_message_count=reservation|get_reservation_all_message_count:user.userProfile new_message_count=reservation|get_reservation_new_message_count:user.userProfile %}
              {% if all_message_count %}
                {% if new_message_count %}
                  <a href="{% url 'bcse:reservationView' reservation.id %}"><strong>{{new_message_count}}</strong></a>/{{all_message_count}}
                {% else %}
                  {{all_message_count}}
                {% endif %}
              {% endif %}
            {% endwith %}
          </td>
          <td>{{reservation.delivery_date|date:"F j, Y"}}</td>
          <td>{{reservation.return_date|date:"F j, Y"}}</td>
          <td>
            {% if reservation.delivery_address %}
              {{reservation.delivery_address.street_address_1}}<br>
              {% if reservation.delivery_address.street_address_2 %}
                {{reservation.delivery_address.street_address_2}}<br>
              {% endif %}
              {{reservation.delivery_address.city}}, {{reservation.delivery_address.state}} {{reservation.delivery_address.zip_code}}
            {% else %}
              {{reservation.user.work_place.name}}<br>
              {{reservation.user.work_place.street_address_1}}<br>
              {% if reservation.user.work_place.street_address_2 %}
                {{reservation.user.work_place.street_address_2}}<br>
              {% endif %}
              {{reservation.user.work_place.city}}, {{reservation.user.work_place.state}} {{reservation.user.work_place.zip_code}}
            {% endif %}
          </td>
          {% if user.is_authenticated and user.userProfile.user_role in 'AS' and tag == 'reservations' %}
            {% if reservation.delivery_address %}
              <td> {{reservation.delivery_address.distance_from_base|default_if_none:""}} </td>
              <td> {{reservation.delivery_address.time_from_base|default_if_none:""}} </td>
            {% else %}
              <td> {{reservation.user.work_place.distance_from_base|default_if_none:""}} </td>
              <td> {{reservation.user.work_place.time_from_base|default_if_none:""}} </td>
            {% endif %}
            <td>{{reservation.assignee.user.get_full_name|default:"Not Assigned"}}</td>
          {% endif %}
          <td> {{reservation.get_status_display}} </td>
          <td>
            <div class="btn-group">
              <button type="button" class="btn btn-small dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                Action
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="{% url 'bcse:reservationView' reservation.id %}">View</a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  {% if user.userProfile.user_role in 'TP' and reservation.status in 'DIO' %}
                    <a class="dropdown-item warn action" data-title="This reservation is <strong>{{reservation.get_status_display}}</strong> and cannot be modified">Edit</a>
                  {% else %}
                    <a class="dropdown-item" href="{% url 'bcse:reservationEdit' reservation.id %}">Edit</a>
                  {% endif %}
                </li>
                {% if user.userProfile.user_role in 'AS' %}
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item modal-open" data-bs-toggle="modal" data-bs-target="#profile" data-href="{% url 'bcse:reservationDeliveryAddressEdit' reservation.id %}" href="#">Update Delivery Address</a></li>
                {% endif %}
                <li><hr class="dropdown-divider"></li>
                <li>
                  {% if reservation.status in 'IO' %}
                    <a class="dropdown-item warn action" data-title="This reservation is <strong>{{reservation.get_status_display}}</strong> and cannot be deleted">Delete</a>
                  {% else %}
                    <a class="dropdown-item delete action" data-href="{% url 'bcse:reservationDelete' reservation.id %}"
                    data-title="the reservation with id <strong>{{reservation.id}}</strong>">
                      Delete
                    </a>
                  {% endif %}
                </li>
              </ul>
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if tag == 'reservations' %}
    {% include "bcse_app/Pagination.html" with model=reservations %}
  {% endif %}
{% else %}
  {% if tag == 'reservations' %}
    <div class="warning center">No reservations matching your search criteria found</div>
  {% endif %}
{% endif %}

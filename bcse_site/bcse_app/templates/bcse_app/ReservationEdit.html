{% extends "bcse_app/base.html" %}
{% load bcse_extras %}

{% block content %}
  {{block.super}}
  <div class="content">
    <div class="reservation_container container">
      {% if form.instance.id %}
        <h1> {{form.instance}} </h1>
      {% else %}
        <h1> Create Reservation </h1>
      {% endif %}
      {% include "bcse_app/ReservationTabs.html" with reservation=form.instance tab='edit'%}
      <div id="reservation_container">
        <div class="reservation_form">
          <form method="post" enctype="multipart/form-data" id="reservationForm">
            {% csrf_token %}

            {% if form.user %}
              <div class="form-group mb-3">
                <label for="id_{{form.user.name}}" class="form-label"> {{form.user.label}}</label>
                <div>{{form.user}}</div>
                <div class="error">{{ form.user.errors }}</div>
              </div>
            {% endif %}
            <div class="form-group mb-3">
              <label for="id_{{form.activity.name}}" class="form-label"> {{form.activity.label}}</label>
              <div>{{form.activity}}</div>
              <div class="error">{{ form.activity.errors }}</div>
            </div>
            <div class="form-group mb-3">
              <label for="id_{{form.other_activity.name}}" class="form-label"> {{form.other_activity.label}}</label>
              <div>{{form.other_activity}}</div>
              <div class="error">{{ form.other_activity.errors }}</div>
            </div>
            <div class="form-group mb-3">
              <label for="id_{{form.other_activity_name.name}}" class="form-label"> {{form.other_activity_name.label}}</label>
              <div>{{form.other_activity_name}}</div>
              <div class="error">{{ form.other_activity_name.errors }}</div>
            </div>
            <div class="form-group mb-3">
              <label for="id_{{form.num_of_classes.name}}" class="form-label"> {{form.num_of_classes.label}}</label>
              <div>{{form.num_of_classes}}</div>
              <div class="error">{{ form.num_of_classes.errors }}</div>
            </div>
            <div class="form-group mb-3">
              <label for="id_{{form.activity_kit_not_needed.name}}" class="form-label"> {{form.activity_kit_not_needed.label}}</label>
              <div>{{form.activity_kit_not_needed}}</div>
              <div class="error">{{ form.activity_kit_not_needed.errors }}</div>
            </div>


            <div class="form-group mb-3">
              <label for="id_{{form.num_of_students.name}}" class="form-label"> {{form.num_of_students.label}}</label>
              <div>{{form.num_of_students}}</div>
              <div class="error">{{ form.num_of_students.errors }}</div>
            </div>

            <div class="form-group mb-3">
              <label for="id_{{form.equipment_not_needed.name}}" class="form-label"> {{form.equipment_not_needed.label}}</label>
              <div>{{form.equipment_not_needed}}</div>
              <div class="error">{{ form.equipment_not_needed.errors }}</div>
            </div>
            <div class="form-group mb-3">
              <label for="id_{{form.equipment_types.name}}" class="form-label"> {{form.equipment_types.label}}</label>
              <div>{{form.equipment_types}}</div>
              <div class="error">{{ form.equipment_types.errors }}</div>
            </div>
            <div class="form-group mb-3 row">
              <div class="col">
                <label for="id_{{form.delivery_date.name}}" class="form-label"> {{form.delivery_date.label}}</label>
                <div class="input-group">
                  {{form.delivery_date}}
                  <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                </div>
                <div class="error">{{ form.delivery_date.errors }}</div>
              </div>
              <div class="col">
                <label for="id_{{form.return_date.name}}" class="form-label"> {{form.return_date.label|title}}</label>
                <div class="input-group">
                  {{form.return_date}}
                  <span class="input-group-text"><i class="fa fa-calendar"></i></span>
                </div>
                <div class="error">{{ form.return_date.errors }}</div>
              </div>
            </div>
            <button class="btn btn-warning" type="button" id="check_availability">Check Availibility</button>

            <div class="form-group mb-3">
              <label for="id_{{form.notes.name}}" class="form-label"> {{form.notes.label}}</label>
              <div>{{form.notes}}</div>
              <div class="error">{{ form.notes.errors }}</div>
            </div>
            <div class="form-group mb-3">
              <label for="id_{{form.additional_help_needed.name}}" class="form-label"> {{form.additional_help_needed.label}}</label>
              <div>{{form.additional_help_needed}}</div>
              <div class="error">{{ form.additional_help_needed.errors }}</div>
            </div>
            <div class="form-group mb-3">
              <label for="id_{{form.status.name}}" class="form-label"> {{form.status.label}}</label>
              <div>{{form.status}}</div>
              <div class="error">{{ form.status.errors }}</div>
            </div>

            <button class="btn btn-success" type="submit" id="submit">
              {% if form.instance.id %}
                Save Reservation
              {% else %}
                Make Reservation
              {% endif %}
            </button>
            {% if form.instance.id %}
              <button class="btn btn-danger delete action" data-href="{% url 'bcse:reservationDelete' form.instance.id %}" data-title="this reservation">Delete</button>
            {% endif %}
          </form>
        </div>
        <div class="other_info">
          <div class="activity_container">
            {% if form.instance.id and form.instance.activity %}
              <div class="activity">
                <h3 class="left"> You have selected {{form.instance.activity}}</h3>
                <div class="activity_info">
                  <div class="activity_image">
                    {% if form.instance.activity.image %}
                      <img src="{{form.instance.activity.image.url}}"/>
                    {% endif %}
                  </div>
                  <div class="activity_details">
                    <div>{{form.instance.activity.description|safe}}</div>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
          <div class="availability_calendar_container">
            {% include "bcse_app/AvailabilityCalendar.html" %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    $(function (){
      toggleCheckAvailability();

      $('button#check_availability').click(function(e){
        e.preventDefault();
        var equipment_types = $('select#id_equipment_types').val();
        var delivery_date = $('input#id_delivery_date').datepicker('getDate');
        var return_date = $('input#id_return_date').datepicker('getDate');
        if (delivery_date > return_date) {
          bootbox.alert({title: "Warning",
                    message: 'Please pick a return date that is later than the delivery date',
                    closeButton: false
                  });
        }
        else {
          data = $('form#reservationForm').serialize();
          var url ='';
          if('{{form.instance.id}}' != 'None') {
            url = '/availability/{{form.instance.id}}';
          }
          else {
            url = '/availability/new';
          }

          $.ajax({
            type: 'POST',
            url: url,
            data: data,
            beforeSend: function(){
              $('div.availability_calendar_container').html('');
            },
            complete: function(){

            },
            success: function(data){
              console.log(data);
              if (data['success'] = true) {
                if (data['html']) {
                  $('div.availability_calendar_container').html(data['html']);
                  if(data['message']) {
                    bootbox.alert({title: "Availability",
                                message: data['message'],
                                closeButton: false
                    });
                  }
                }
                else {
                  displayErrorDialog();
                }
              }
              else {
                displayErrorDialog();
              }
              return false;
            },
            error: function(xhr, ajaxOptions, thrownError){
              displayErrorDialog();
            },
          });
        }

      });


      function toggleCheckAvailability() {
        if($('select#id_equipment_types').val() && $('input#id_delivery_date').val() && $('input#id_return_date').val()) {
          $('button#check_availability').attr('disabled', false);
        }
        else{
          $('button#check_availability').attr('disabled', 'disabled');
        }
      }

      $('select#id_equipment_types, input#id_delivery_date, input#id_return_date').on('change', function(){
        toggleCheckAvailability();
      });


    });
  </script>
{% endblock %}
